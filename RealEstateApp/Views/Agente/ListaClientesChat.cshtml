@using RealEstateApp.Web.ViewModels
@using System.Linq
@model IEnumerable<ClienteListadoVM>

@{
    Layout = "~/Views/Shared/_LayoutAgente.cshtml";
    ViewData["Title"] = "Clientes";
    var propiedadId = (int)ViewBag.PropiedadId;
    string codigo = ViewBag.CodigoPropiedad as string ?? "";
}

<style>
    .list-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,.06);
        overflow: hidden
    }

    .list-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        border-bottom: 1px solid #eef1f4;
        background: linear-gradient(180deg,#fff,#f8fbff)
    }

        .list-head .title {
            font-weight: 700;
            display: flex;
            gap: .5rem;
            align-items: center
        }

        .list-head .code {
            font-size: .9rem;
            color: #6b7280
        }

    .list-actions {
        display: flex;
        gap: .5rem;
        align-items: center
    }

    #q {
        max-width: 260px
    }

    .row-item {
        display: flex;
        gap: 12px;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f5;
        text-decoration: none;
        color: inherit
    }

        .row-item:hover {
            background: #f8fbff
        }

    .row-left {
        flex: 1;
        min-width: 0
    }

    .row-name {
        font-weight: 600
    }

    .row-last {
        font-size: .9rem;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 520px
    }

    .row-right {
        text-align: right
    }

    .badge-unread {
        font-size: .72rem
    }
</style>

<div class="container mt-4">
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <h3 class="mb-0">👥 Clientes</h3>
        <a class="btn btn-outline-secondary btn-sm" href="@Url.Action("Detalle", "Propiedad", new { codigo })">← Volver a propiedad</a>
    </div>

    <div class="list-card">
        <div class="list-head">
            <div class="title">
                <i class="bi bi-people"></i> Todos los clientes
                <span class="code">(Propiedad: @codigo)</span>
            </div>
            <div class="list-actions">
                <input id="q" class="form-control form-control-sm" placeholder="Buscar por nombre o correo..." />
            </div>
        </div>

        @if (Model == null || !Model.Any())
        {
            <div class="p-3 text-muted">No hay clientes registrados.</div>
        }
        else
        {
            <div id="list">
                @foreach (var c in Model)
                {
                    var url = Url.Action("ChatConCliente", "Agente",
                    new { propiedadId = propiedadId, clienteId = c.Id });

                    <div class="row-item" data-nombre="@c.Nombre.ToLower()" data-correo="@c.Correo.ToLower()">
                        <div class="row-left">
                            <div class="row-name">
                                @c.Nombre
                                @if (c.NoLeidos > 0)
                                {
                                    <span class="badge bg-danger badge-unread">@c.NoLeidos sin leer</span>
                                }
                                @if (c.TieneChat)
                                {
                                    <span class="badge bg-primary ms-1">conversación</span>
                                }
                            </div>
                            <div class="text-muted small">@c.Correo · @c.Telefono</div>
                            @if (!string.IsNullOrWhiteSpace(c.UltimoTexto))
                            {
                                <div class="row-last">@c.UltimoTexto</div>
                            }
                        </div>
                        <div class="row-right">
                            @if (c.UltimaFecha.HasValue)
                            {
                                <div class="text-muted small">@c.UltimaFecha.Value.ToString("dd/MM/yyyy HH:mm")</div>
                            }
                            <a class="btn btn-sm btn-success mt-2" href="@url">Chatear</a>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
     
        (function(){
          const q = document.getElementById('q');
          const list = document.getElementById('list');
          if (!q || !list) return;
          q.addEventListener('input', () => {
              const s = (q.value || '').trim().toLowerCase();
              list.querySelectorAll('.row-item').forEach(el => {
                  const nom = el.getAttribute('data-nombre') || '';
                  const cor = el.getAttribute('data-correo') || '';
                  el.style.display = (nom.includes(s) || cor.includes(s)) ? '' : 'none';
              });
          });
        })();
    </script>
}
